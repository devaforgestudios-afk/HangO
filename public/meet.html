<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HangO â€” Meeting</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="nav nav--dock">
    <div class="container">
      <div class="nav-dock">
        <a href="/" class="brand" aria-label="HangO home">
          <svg class="logo-mark" width="34" height="34" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g1m" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#22d3ee"/>
              <stop offset="50%" stop-color="#a78bfa"/>
              <stop offset="100%" stop-color="#f472b6"/>
            </linearGradient>
          </defs>
          <rect x="4" y="8" width="40" height="32" rx="10" stroke="url(#g1m)" stroke-width="3"/>
          <circle cx="16" cy="24" r="6" fill="url(#g1m)"/>
          <circle cx="32" cy="24" r="6" stroke="url(#g1m)" stroke-width="3" fill="none"/>
          </svg>
          <span class="brand__name text-gradient">HangO</span>
        </a>
        <button class="nav-toggle" aria-label="Open menu" aria-expanded="false" aria-controls="navMenu">
          <span></span><span></span><span></span>
        </button>
        <nav id="navMenu" class="nav-menu">
          <a class="nav-link" href="/">Home</a>
          <a class="nav-link" href="/auth.html">Account</a>
          <div class="nav-split"></div>
          <a href="/" class="btn btn--ghost">Leave</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="container" style="padding:32px 16px">
    <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px">
      <div>
        <h1 style="margin:0">Meeting <span id="code"></span></h1>
        <p id="meetingTitle" style="margin:4px 0 0; color:var(--muted); font-size:0.875rem"></p>
      </div>
      <div style="display:flex; gap:8px">
        <button id="copy" class="btn btn--ghost">Copy link</button>
        <button id="newCode" class="btn">New code</button>
      </div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status" style="margin-top:16px">
      <div class="status-indicator">
        <div class="status-dot connecting"></div>
        <span>Connecting to meeting...</span>
      </div>
    </div>

    <div class="features__grid" style="margin-top:16px">
      <div class="feature" style="display:grid; gap:12px">
        <h3>Your Camera</h3>
        <div class="preview" id="localPreview">
          <video id="localVideo" class="preview__video" autoplay muted playsinline></video>
          <canvas id="meter" class="preview__meter" aria-hidden="true"></canvas>
          <div id="videoPlaceholder" class="video-placeholder">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="7" width="12" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
              <path d="M15 10l5-3v10l-5-3v-4Z" fill="currentColor"/>
            </svg>
            <p>Camera is off</p>
          </div>
        </div>
        <div class="controls">
          <button id="btnMic" class="toggle" aria-pressed="true" aria-label="Toggle microphone" title="Mic">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Z" stroke="currentColor" stroke-width="2"/><path d="M5 12a7 7 0 0 0 14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 19v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <button id="btnCam" class="toggle" aria-pressed="true" aria-label="Toggle camera" title="Camera">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="7" width="12" height="10" rx="2" stroke="currentColor" stroke-width="2"/><path d="M15 10l5-3v10l-5-3v-4Z" fill="currentColor"/></svg>
          </button>
          <button id="btnScreen" class="toggle" aria-pressed="false" aria-label="Toggle screen share" title="Screen share">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="5" width="18" height="12" rx="2" stroke="currentColor" stroke-width="2"/><path d="M7 21h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>
      </div>
      <div class="feature">
        <h3>Participants</h3>
        <div id="list" class="muted">
          <div class="participant-item">
            <div class="participant-avatar">You</div>
            <div class="participant-info">
              <div class="participant-name">You</div>
              <div class="participant-status">Host</div>
            </div>
          </div>
        </div>
      </div>
      <div class="feature" style="grid-column: span 2;">
        <h3>Chat</h3>
        <div id="chat" style="height:220px; overflow:auto; background:#0b1220; border:1px solid #243040; border-radius:12px; padding:12px" class="muted">
          <div class="chat-message system">
            <span>Meeting started. Share the code to invite others!</span>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px">
          <input id="msg" class="input" placeholder="Type a message" style="flex:1" />
          <button id="send" class="btn">Send</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);
    function getCode(){
      const p = new URLSearchParams(location.search);
      return (p.get('code')||'').toUpperCase();
    }
    function setCode(c){ $('code').textContent = c ? `#${c}` : '(no code)'; }
    function randomCode(){ return Math.random().toString(36).slice(2, 8).toUpperCase(); }

    function mount(){
      const code = getCode() || randomCode();
      if (!getCode()) {
        const url = new URL(location.href);
        url.searchParams.set('code', code);
        history.replaceState(null, '', url);
      }
      setCode(code);

      // Load meeting settings from localStorage
      const meetingSettings = JSON.parse(localStorage.getItem('meetingSettings') || '{}');
      const titleElement = $('meetingTitle');
      if (titleElement && meetingSettings.title) {
        titleElement.textContent = meetingSettings.title;
      }

      // Apply initial device settings
      if (meetingSettings.enableVideo === false) {
        const btnCam = $('btnCam');
        if (btnCam) toggle(btnCam);
      }
      if (meetingSettings.enableAudio === false) {
        const btnMic = $('btnMic');
        if (btnMic) toggle(btnMic);
      }

      // Update connection status
      setTimeout(() => {
        const statusElement = $('connectionStatus');
        if (statusElement) {
          statusElement.innerHTML = `
            <div class="status-indicator">
              <div class="status-dot connected"></div>
              <span>Connected to meeting ${code}</span>
            </div>
          `;
        }
      }, 1500);

      // WebRTC setup
      let localStream = null;
      let isVideoEnabled = meetingSettings.enableVideo !== false;
      let isAudioEnabled = meetingSettings.enableAudio !== false;

      async function initializeMedia() {
        try {
          const constraints = {
            video: isVideoEnabled,
            audio: isAudioEnabled
          };

          localStream = await navigator.mediaDevices.getUserMedia(constraints);
          const localVideo = $('localVideo');
          const placeholder = $('videoPlaceholder');
          
          if (localVideo && localStream) {
            localVideo.srcObject = localStream;
            if (isVideoEnabled) {
              localVideo.style.display = 'block';
              if (placeholder) placeholder.style.display = 'none';
            } else {
              localVideo.style.display = 'none';
              if (placeholder) placeholder.style.display = 'flex';
            }
          }

          // Update button states
          updateControlStates();
          
        } catch (error) {
          console.error('Error accessing media devices:', error);
          showMediaError(error);
        }
      }

      function updateControlStates() {
        const btnMic = $('btnMic');
        const btnCam = $('btnCam');
        
        if (btnMic) {
          btnMic.setAttribute('aria-pressed', isAudioEnabled);
          btnMic.classList.toggle('disabled', !isAudioEnabled);
        }
        
        if (btnCam) {
          btnCam.setAttribute('aria-pressed', isVideoEnabled);
          btnCam.classList.toggle('disabled', !isVideoEnabled);
        }
      }

      function showMediaError(error) {
        const statusElement = $('connectionStatus');
        if (statusElement) {
          let errorMessage = 'Unable to access camera/microphone';
          if (error.name === 'NotAllowedError') {
            errorMessage = 'Camera/microphone access denied. Please allow permissions.';
          } else if (error.name === 'NotFoundError') {
            errorMessage = 'No camera/microphone found.';
          }
          
          statusElement.innerHTML = `
            <div class="status-indicator">
              <div class="status-dot disconnected"></div>
              <span>${errorMessage}</span>
            </div>
          `;
        }
      }

      // Initialize media when page loads
      initializeMedia();

      $('copy').onclick = async () => {
        const share = `${location.origin}/meet.html?code=${encodeURIComponent(getCode())}`;
        try { await navigator.clipboard.writeText(share); } catch {}
        $('copy').textContent = 'Copied!';
        setTimeout(()=> $('copy').textContent = 'Copy link', 1200);
      };

      $('newCode').onclick = () => {
        const c = randomCode();
        const url = new URL(location.href);
        url.searchParams.set('code', c);
        history.replaceState(null, '', url);
        setCode(c);
      };

      const chat = $('chat');
      $('send').onclick = () => {
        const v = $('msg').value.trim();
        if (!v) return;
        const line = document.createElement('div');
        line.textContent = `You: ${v}`;
        chat.appendChild(line);
        chat.scrollTop = chat.scrollHeight;
        $('msg').value = '';
      };

      // Left panel interactions (simulated preview + audio meter)
      const btnMic = $('btnMic');
      const btnCam = $('btnCam');
      const btnScreen = $('btnScreen');
      const meter = $('meter');
      const mctx = meter.getContext('2d');
      function resizeMeter(){
        const DPR = Math.min(2, window.devicePixelRatio||1);
        meter.width = meter.clientWidth * DPR; meter.height = meter.clientHeight * DPR; mctx.setTransform(DPR,0,0,DPR,0,0);
      }
      resizeMeter();
      window.addEventListener('resize', resizeMeter);

      function drawMeter(level){
        const w = meter.width / (window.devicePixelRatio||1), h = meter.height / (window.devicePixelRatio||1);
        mctx.clearRect(0,0,w,h);
        mctx.fillStyle = 'rgba(148,163,184,.25)';
        mctx.fillRect(0,0,w,h);
        const grad = mctx.createLinearGradient(0,0,w,0);
        grad.addColorStop(0,'#22d3ee'); grad.addColorStop(.5,'#a78bfa'); grad.addColorStop(1,'#f472b6');
        mctx.fillStyle = grad; mctx.fillRect(2,2,(w-4)*level, h-4);
      }
      let t = 0; function tick(){ t+=0.08; const lv = 0.15 + (Math.sin(t)+1)/2 * 0.75; drawMeter(lv); requestAnimationFrame(tick); } tick();

      function toggle(btn){
        const isPressed = btn.getAttribute('aria-pressed') === 'true';
        const newState = !isPressed;
        btn.setAttribute('aria-pressed', String(newState));
        btn.classList.toggle('disabled', !newState);
        
        // Handle actual media stream controls
        if (btn.id === 'btnMic' && localStream) {
          const audioTracks = localStream.getAudioTracks();
          audioTracks.forEach(track => track.enabled = newState);
          isAudioEnabled = newState;
        } else if (btn.id === 'btnCam' && localStream) {
          const videoTracks = localStream.getVideoTracks();
          videoTracks.forEach(track => track.enabled = newState);
          isVideoEnabled = newState;
          
          const localVideo = $('localVideo');
          const placeholder = $('videoPlaceholder');
          if (localVideo && placeholder) {
            if (newState) {
              localVideo.style.display = 'block';
              placeholder.style.display = 'none';
            } else {
              localVideo.style.display = 'none';
              placeholder.style.display = 'flex';
            }
          }
        } else if (btn.id === 'btnScreen') {
          // Screen share functionality (placeholder)
          if (newState) {
            // Would implement screen sharing here
            console.log('Screen share started');
          } else {
            console.log('Screen share stopped');
          }
        }
      }
      btnMic.onclick = ()=> toggle(btnMic);
      btnCam.onclick = ()=> toggle(btnCam);
      btnScreen.onclick = ()=> toggle(btnScreen);
    }

    mount();
  </script>
</body>
</html>
