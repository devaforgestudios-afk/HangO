<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HangO â€” Meeting</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    /* Meeting-specific styles for immersive experience */
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow-x: hidden;
      position: relative;
    }
    
    /* Fun background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(2px 2px at 20px 30px, rgba(59, 130, 246, 0.3), transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(139, 92, 246, 0.2), transparent),
        radial-gradient(1px 1px at 90px 40px, rgba(244, 114, 182, 0.3), transparent),
        radial-gradient(1px 1px at 130px 80px, rgba(34, 211, 238, 0.2), transparent),
        radial-gradient(2px 2px at 160px 30px, rgba(167, 139, 250, 0.3), transparent);
      background-repeat: repeat;
      background-size: 200px 100px;
      animation: sparkle 20s linear infinite;
      pointer-events: none;
      z-index: 1;
    }
    
    @keyframes sparkle {
      from { transform: translateY(0px); }
      to { transform: translateY(-100px); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    .meeting-container {
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
      background: linear-gradient(135deg, #0a0a23 0%, #1a1a2e  50%, #16213e 100%);
      position: relative;
      z-index: 10;
    }
    
    .meeting-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      z-index: 100;
    }
    
    .meeting-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .meeting-code {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    
    .meeting-title {
      color: #e2e8f0;
      font-size: 18px;
      font-weight: 500;
      margin: 0;
    }
    
    .meeting-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .header-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 500;
    }
    
    .header-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }
    
    .leave-btn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border: none;
      color: white;
      padding: 8px 20px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .leave-btn:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-1px);
    }
    
    .meeting-main {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 20px;
      padding: 20px;
      height: calc(100vh - 140px);
      overflow: hidden;
    }
    
    .video-area {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    .main-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 20px;
    }
    
    .video-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      color: #64748b;
      text-align: center;
    }
    
    .video-placeholder svg {
      width: 64px;
      height: 64px;
      opacity: 0.6;
    }
    
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .sidebar-section {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    
    .section-title {
      color: #e2e8f0;
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 12px 0;
    }
    
    .participants-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .participant {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    
    .participant:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .participant-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
    }
    
    .participant-name {
      color: #e2e8f0;
      font-weight: 500;
    }
    
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .chat-messages {
      flex: 1;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      overflow-y: auto;
      max-height: 200px;
    }
    
    .chat-message {
      color: #cbd5e1;
      font-size: 14px;
      margin-bottom: 8px;
      padding: 6px 0;
    }
    
    .chat-message.system {
      color: #64748b;
      font-style: italic;
    }
    
    .chat-input-area {
      display: flex;
      gap: 8px;
    }
    
    .chat-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 8px 12px;
      color: white;
      outline: none;
    }
    
    .chat-input::placeholder {
      color: #64748b;
    }
    
    .chat-send {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .controls-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }
    
    .control-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .control-btn.active {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 2px solid #22c55e;
    }
    
    .control-btn.disabled {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 2px solid #ef4444;
    }
    
    .control-btn.neutral {
      background: rgba(255, 255, 255, 0.1);
      color: #e2e8f0;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .control-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    }
    
    .control-btn:active {
      transform: scale(0.95);
    }
    
    .control-btn.active:hover {
      box-shadow: 0 8px 30px rgba(34, 197, 94, 0.3);
    }
    
    .control-btn.disabled:hover {
      box-shadow: 0 8px 30px rgba(239, 68, 68, 0.3);
    }
    
    .control-btn svg {
      width: 24px;
      height: 24px;
    }
    
    .end-call-btn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      width: 64px;
      height: 64px;
    }
    
    .end-call-btn:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
    }
    
    @media (max-width: 768px) {
      .meeting-main {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
      }
      
      .sidebar {
        max-height: 300px;
        overflow-y: auto;
      }
    }
  </style>
</head>
<body>
  <div class="meeting-container">
    <!-- Header -->
    <header class="meeting-header">
      <div class="meeting-info">
        <div class="meeting-code" id="code"></div>
        <h1 class="meeting-title" id="meetingTitle">Meeting Room</h1>
      </div>
      <div class="meeting-actions">
        <button id="copy" class="header-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
            <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" stroke="currentColor" stroke-width="2"/>
          </svg>
          Copy Link
        </button>
        <button id="newCode" class="header-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
          </svg>
          New Code
        </button>
        <button class="leave-btn" onclick="window.location.href='/'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9" stroke="currentColor" stroke-width="2"/>
          </svg>
          Leave
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="meeting-main">
      <!-- Video Area -->
      <div class="video-area">
        <video id="localVideo" class="main-video" autoplay muted playsinline style="display:none;"></video>
        <div id="videoPlaceholder" class="video-placeholder">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="7" width="12" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M15 10l5-3v10l-5-3v-4Z" fill="currentColor"/>
          </svg>
          <h3 style="margin:0; color:#64748b;">Camera is off</h3>
          <p style="margin:0; color:#475569;">Enable your camera to start the meeting</p>
        </div>
        
        <!-- Connection Status Overlay -->
        <div id="connectionStatus" style="position:absolute; top:16px; left:16px; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); color:white; padding:10px 16px; border-radius:25px; font-size:14px; font-weight:500; border:1px solid rgba(255,255,255,0.1);">
          <div class="status-indicator">
            <div class="status-dot connecting" style="width:8px; height:8px; border-radius:50%; background:#f59e0b; margin-right:8px; display:inline-block; animation:pulse 2s infinite;"></div>
            <span>Connecting...</span>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Participants -->
        <div class="sidebar-section">
          <h3 class="section-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline; margin-right:8px;">
              <path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2" stroke="currentColor" stroke-width="2"/>
              <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
              <path d="M22 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" stroke="currentColor" stroke-width="2"/>
            </svg>
            Participants (1)
          </h3>
          <div class="participants-list" id="list">
            <div class="participant">
              <div class="participant-avatar">Y</div>
              <div class="participant-name">You (Host)</div>
            </div>
          </div>
        </div>

        <!-- Chat -->
        <div class="sidebar-section chat-area">
          <h3 class="section-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline; margin-right:8px;">
              <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" stroke="currentColor" stroke-width="2"/>
            </svg>
            Chat
          </h3>
          <div id="chat" class="chat-messages">
            <div class="chat-message system">
              Welcome to the meeting! Share the meeting code to invite others.
            </div>
          </div>
          <div class="chat-input-area">
            <input id="msg" class="chat-input" placeholder="Type a message..." />
            <button id="send" class="chat-send">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 2L2 8.67l6.82 2.73L22 2z" fill="currentColor"/>
                <path d="M8.82 11.4l3.18 8.6L22 2l-13.18 9.4z" fill="currentColor"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Controls Bar -->
    <div class="controls-bar">
      <button id="btnMic" class="control-btn active" aria-pressed="true" title="Microphone">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 15a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Z" stroke="currentColor" stroke-width="2"/>
          <path d="M5 12a7 7 0 0 0 14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 19v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <button id="btnCam" class="control-btn active" aria-pressed="true" title="Camera">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="7" width="12" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
          <path d="M15 10l5-3v10l-5-3v-4Z" fill="currentColor"/>
        </svg>
      </button>

      <button id="btnScreen" class="control-btn neutral" aria-pressed="false" title="Share Screen">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="5" width="18" height="12" rx="2" stroke="currentColor" stroke-width="2"/>
          <path d="M7 21h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <button class="control-btn end-call-btn" title="End Meeting" onclick="window.location.href='/'">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0017.07 7H18a2 2 0 012 2v9a2 2 0 01-2 2H6a2 2 0 01-2-2V9z" stroke="currentColor" stroke-width="2"/>
          <path d="M15 13l-6-6" stroke="currentColor" stroke-width="2"/>
          <path d="M9 13l6-6" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    function getCode(){
      const p = new URLSearchParams(location.search);
      return (p.get('code')||'').toUpperCase();
    }
    function setCode(c){ $('code').textContent = c ? `#${c}` : '(no code)'; }
    function randomCode(){ return Math.random().toString(36).slice(2, 8).toUpperCase(); }

    function mount(){
      const code = getCode() || randomCode();
      if (!getCode()) {
        const url = new URL(location.href);
        url.searchParams.set('code', code);
        history.replaceState(null, '', url);
      }
      setCode(code);

      // Load meeting details from API
      loadMeetingDetails(code);

      // Apply initial device settings from localStorage (fallback)
      const meetingSettings = JSON.parse(localStorage.getItem('meetingSettings') || '{}');
      if (meetingSettings.enableVideo === false) {
        const btnCam = $('btnCam');
        if (btnCam) toggle(btnCam);
      } 
      if (meetingSettings.enableAudio === false) {
        const btnMic = $('btnMic');
        if (btnMic) toggle(btnMic);
      }

      // Add some fun startup effects
      setTimeout(() => {
        addChatMessage('system', 'ðŸŽ‰ Meeting room ready! Share your code to invite others.');
        showNotification('Meeting Started', 'Your meeting room is now active');
      }, 1000);
      
      // Simulate random join events (for demo)
      setTimeout(() => {
        if (Math.random() > 0.7) {
          addParticipant('Guest User', false);
          addChatMessage('system', 'ðŸ‘‹ Guest User joined the meeting');
          showNotification('New Participant', 'Guest User joined');
        }
      }, 10000);
    }
    
    function addChatMessage(type, message) {
      const chat = $('chat');
      const line = document.createElement('div');
      line.className = `chat-message ${type}`;
      line.innerHTML = message;
      line.style.opacity = '0';
      line.style.transform = 'translateY(10px)';
      line.style.transition = 'all 0.3s ease';
      
      chat.appendChild(line);
      
      requestAnimationFrame(() => {
        line.style.opacity = '1';
        line.style.transform = 'translateY(0)';
      });
      
      chat.scrollTop = chat.scrollHeight;
    }
    
    function addParticipant(name, isHost = false) {
      const list = $('list');
      const participant = document.createElement('div');
      participant.className = 'participant';
      participant.innerHTML = `
        <div class="participant-avatar">${name.charAt(0).toUpperCase()}</div>
        <div class="participant-name">${name}${isHost ? ' (Host)' : ''}</div>
      `;
      participant.style.opacity = '0';
      participant.style.transform = 'translateX(-20px)';
      participant.style.transition = 'all 0.3s ease';
      
      list.appendChild(participant);
      
      requestAnimationFrame(() => {
        participant.style.opacity = '1';
        participant.style.transform = 'translateX(0)';
      });
    }
    
    function showNotification(title, message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(10px);
        color: white;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 1000;
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 300px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      `;
      
      notification.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px;">${title}</div>
        <div style="font-size: 14px; opacity: 0.8;">${message}</div>
      `;
      
      document.body.appendChild(notification);
      
      requestAnimationFrame(() => {
        notification.style.transform = 'translateX(0)';
      });
      
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    async function loadMeetingDetails(code) {
      try {
        const response = await fetch(`/api/meeting/${code}`);
        const result = await response.json();

        if (result.success && result.meeting) {
          const meeting = result.meeting;
          
          // Update meeting title
          const titleElement = $('meetingTitle');
          if (titleElement) {
            titleElement.textContent = meeting.title;
          }
          
          // Apply meeting settings if available
          const settings = meeting.settings || {};
          if (settings.enableVideo === false) {
            const btnCam = $('btnCam');
            if (btnCam) toggle(btnCam);
          }
          if (settings.enableAudio === false) {
            const btnMic = $('btnMic');
            if (btnMic) toggle(btnMic);
          }
          
          console.log('Meeting loaded:', meeting);
        } else {
          // Meeting might not exist yet, that's okay for new meetings
          console.log('Meeting not found, creating new session');
          
          // Load from localStorage as fallback
          const meetingSettings = JSON.parse(localStorage.getItem('meetingSettings') || '{}');
          const titleElement = $('meetingTitle');
          if (titleElement && meetingSettings.title) {
            titleElement.textContent = meetingSettings.title;
          }
        }
      } catch (error) {
        console.error('Error loading meeting details:', error);
        
        // Fallback to localStorage
        const meetingSettings = JSON.parse(localStorage.getItem('meetingSettings') || '{}');
        const titleElement = $('meetingTitle');
        if (titleElement && meetingSettings.title) {
          titleElement.textContent = meetingSettings.title;
        }
      }
        const btnCam = $('btnCam');
        if (btnCam) toggle(btnCam);
      }
      if (meetingSettings.enableAudio === false) {
        const btnMic = $('btnMic');
        if (btnMic) toggle(btnMic);
      }

      // Update connection status
      setTimeout(() => {
        const statusElement = $('connectionStatus');
        if (statusElement) {
          statusElement.innerHTML = `
            <div class="status-indicator">
              <div class="status-dot connected" style="width:8px; height:8px; border-radius:50%; background:#22c55e; margin-right:8px; display:inline-block;"></div>
              <span>Connected â€¢ ${code}</span>
            </div>
          `;
        }
      }, 1500);

      // WebRTC setup
      let localStream = null;
      let isVideoEnabled = meetingSettings.enableVideo !== false;
      let isAudioEnabled = meetingSettings.enableAudio !== false;

      async function initializeMedia() {
        try {
          const constraints = {
            video: isVideoEnabled,
            audio: isAudioEnabled
          };

          localStream = await navigator.mediaDevices.getUserMedia(constraints);
          const localVideo = $('localVideo');
          const placeholder = $('videoPlaceholder');
          
          if (localVideo && localStream) {
            localVideo.srcObject = localStream;
            if (isVideoEnabled) {
              localVideo.style.display = 'block';
              if (placeholder) placeholder.style.display = 'none';
            } else {
              localVideo.style.display = 'none';
              if (placeholder) placeholder.style.display = 'flex';
            }
          }

          // Update button states
          updateControlStates();
          
        } catch (error) {
          console.error('Error accessing media devices:', error);
          showMediaError(error);
        }
      }

      function updateControlStates() {
        const btnMic = $('btnMic');
        const btnCam = $('btnCam');
        
        if (btnMic) {
          btnMic.setAttribute('aria-pressed', isAudioEnabled);
          btnMic.classList.toggle('disabled', !isAudioEnabled);
        }
        
        if (btnCam) {
          btnCam.setAttribute('aria-pressed', isVideoEnabled);
          btnCam.classList.toggle('disabled', !isVideoEnabled);
        }
      }

      function showMediaError(error) {
        const statusElement = $('connectionStatus');
        if (statusElement) {
          let errorMessage = 'Unable to access camera/microphone';
          if (error.name === 'NotAllowedError') {
            errorMessage = 'Camera/microphone access denied. Please allow permissions.';
          } else if (error.name === 'NotFoundError') {
            errorMessage = 'No camera/microphone found.';
          }
          
          statusElement.innerHTML = `
            <div class="status-indicator">
              <div class="status-dot disconnected"></div>
              <span>${errorMessage}</span>
            </div>
          `;
        }
      }

      // Initialize media when page loads
      initializeMedia();

      $('copy').onclick = async () => {
        const share = `${location.origin}/meet.html?code=${encodeURIComponent(getCode())}`;
        try { await navigator.clipboard.writeText(share); } catch {}
        $('copy').textContent = 'Copied!';
        setTimeout(()=> $('copy').textContent = 'Copy link', 1200);
      };

      $('newCode').onclick = () => {
        const c = randomCode();
        const url = new URL(location.href);
        url.searchParams.set('code', c);
        history.replaceState(null, '', url);
        setCode(c);
      };

      const chat = $('chat');
      $('send').onclick = () => {
        const v = $('msg').value.trim();
        if (!v) return;
        
        const line = document.createElement('div');
        line.className = 'chat-message';
        line.innerHTML = `<strong style="color:#3b82f6;">You:</strong> ${v}`;
        line.style.opacity = '0';
        line.style.transform = 'translateY(10px)';
        line.style.transition = 'all 0.3s ease';
        
        chat.appendChild(line);
        
        // Animate message in
        requestAnimationFrame(() => {
          line.style.opacity = '1';
          line.style.transform = 'translateY(0)';
        });
        
        chat.scrollTop = chat.scrollHeight;
        $('msg').value = '';
        
        // Add typing indicator simulation (fun feature)
        setTimeout(() => {
          const typingLine = document.createElement('div');
          typingLine.className = 'chat-message system';
          typingLine.innerHTML = `<em style="color:#64748b;">Others are typing...</em>`;
          typingLine.style.opacity = '0.7';
          chat.appendChild(typingLine);
          chat.scrollTop = chat.scrollHeight;
          
          setTimeout(() => {
            if (typingLine.parentNode) {
              typingLine.remove();
            }
          }, 2000);
        }, 1000);
      };
      
      // Add Enter key support for chat
      $('msg').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          $('send').click();
        }
      });

      // Left panel interactions (simulated preview + audio meter)
      const btnMic = $('btnMic');
      const btnCam = $('btnCam');
      const btnScreen = $('btnScreen');
      const meter = $('meter');
      const mctx = meter.getContext('2d');
      function resizeMeter(){
        const DPR = Math.min(2, window.devicePixelRatio||1);
        meter.width = meter.clientWidth * DPR; meter.height = meter.clientHeight * DPR; mctx.setTransform(DPR,0,0,DPR,0,0);
      }
      resizeMeter();
      window.addEventListener('resize', resizeMeter);

      function drawMeter(level){
        const w = meter.width / (window.devicePixelRatio||1), h = meter.height / (window.devicePixelRatio||1);
        mctx.clearRect(0,0,w,h);
        mctx.fillStyle = 'rgba(148,163,184,.25)';
        mctx.fillRect(0,0,w,h);
        const grad = mctx.createLinearGradient(0,0,w,0);
        grad.addColorStop(0,'#22d3ee'); grad.addColorStop(.5,'#a78bfa'); grad.addColorStop(1,'#f472b6');
        mctx.fillStyle = grad; mctx.fillRect(2,2,(w-4)*level, h-4);
      }
      let t = 0; function tick(){ t+=0.08; const lv = 0.15 + (Math.sin(t)+1)/2 * 0.75; drawMeter(lv); requestAnimationFrame(tick); } tick();

      function toggle(btn){
        const isPressed = btn.getAttribute('aria-pressed') === 'true';
        const newState = !isPressed;
        btn.setAttribute('aria-pressed', String(newState));
        
        // Update button styling based on new state
        btn.classList.remove('active', 'disabled', 'neutral');
        if (newState) {
          btn.classList.add('active');
        } else {
          btn.classList.add('disabled');
        }
        
        // Handle actual media stream controls
        if (btn.id === 'btnMic' && localStream) {
          const audioTracks = localStream.getAudioTracks();
          audioTracks.forEach(track => track.enabled = newState);
          isAudioEnabled = newState;
          
          // Add visual feedback for mic mute/unmute
          if (!newState) {
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 15a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Z" stroke="currentColor" stroke-width="2"/>
              <path d="M5 12a7 7 0 0 0 14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 19v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"/>
            </svg>`;
          } else {
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 15a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Z" stroke="currentColor" stroke-width="2"/>
              <path d="M5 12a7 7 0 0 0 14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 19v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>`;
          }
        } else if (btn.id === 'btnCam' && localStream) {
          const videoTracks = localStream.getVideoTracks();
          videoTracks.forEach(track => track.enabled = newState);
          isVideoEnabled = newState;
          
          const localVideo = $('localVideo');
          const placeholder = $('videoPlaceholder');
          if (localVideo && placeholder) {
            if (newState) {
              localVideo.style.display = 'block';
              placeholder.style.display = 'none';
            } else {
              localVideo.style.display = 'none';
              placeholder.style.display = 'flex';
            }
          }
          
          // Update camera icon
          if (!newState) {
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="7" width="12" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
              <path d="M15 10l5-3v10l-5-3v-4Z" fill="currentColor"/>
              <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"/>
            </svg>`;
          } else {
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="7" width="12" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
              <path d="M15 10l5-3v10l-5-3v-4Z" fill="currentColor"/>
            </svg>`;
          }
        } else if (btn.id === 'btnScreen') {
          // Screen share functionality (placeholder)
          if (newState) {
            btn.classList.remove('neutral');
            btn.classList.add('active');
            console.log('Screen share started');
          } else {
            btn.classList.remove('active');
            btn.classList.add('neutral');
            console.log('Screen share stopped');
          }
        }
      }
      btnMic.onclick = ()=> toggle(btnMic);
      btnCam.onclick = ()=> toggle(btnCam);
      btnScreen.onclick = ()=> toggle(btnScreen);
    
    mount();
  </script>
</body>
</html>
