<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HangO — Meeting</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="/socket.io/socket.io.js"></script>
  <script src="/webrtc-client.js"></script>
  <style>
    /* Meeting-specific styles for immersive experience */
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow-x: hidden;
      position: relative;
    }
    
    /* Fun background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(2px 2px at 20px 30px, rgba(59, 130, 246, 0.3), transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(139, 92, 246, 0.2), transparent),
        radial-gradient(1px 1px at 90px 40px, rgba(244, 114, 182, 0.3), transparent),
        radial-gradient(1px 1px at 130px 80px, rgba(34, 211, 238, 0.2), transparent),
        radial-gradient(2px 2px at 160px 30px, rgba(167, 139, 250, 0.3), transparent);
      background-repeat: repeat;
      background-size: 200px 100px;
      animation: sparkle 20s linear infinite;
      pointer-events: none;
      z-index: 1;
    }
    
    @keyframes sparkle {
      from { transform: translateY(0px); }
      to { transform: translateY(-100px); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    .meeting-container {
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
      background: linear-gradient(135deg, #0a0a23 0%, #1a1a2e  50%, #16213e 100%);
      position: relative;
      z-index: 10;
    }
    
    .meeting-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      z-index: 100;
    }
    
    .meeting-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .meeting-code {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    
    .meeting-title {
      color: #e2e8f0;
      font-size: 18px;
      font-weight: 500;
      margin: 0;
    }
    
    .meeting-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .header-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .header-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    #copy {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border: 1px solid rgba(59, 130, 246, 0.5);
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }
    
    #copy:hover {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }
    
    #copy:active {
      transform: translateY(0);
    }
    
    #copy::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transform: rotate(45deg);
      transition: all 0.6s ease;
      opacity: 0;
    }
    
    #copy:hover::before {
      opacity: 1;
      transform: rotate(45deg) translate(50%, 50%);
    }
    
    .leave-btn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border: none;
      color: white;
      padding: 8px 20px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .leave-btn:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-1px);
    }
    
    .meeting-main {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 20px;
      padding: 20px;
      height: calc(100vh - 140px);
      overflow: hidden;
    }
    
    .video-area {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    .main-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 20px;
    }
    
    .video-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      color: #64748b;
      text-align: center;
    }
    
    .video-placeholder svg {
      width: 64px;
      height: 64px;
      opacity: 0.6;
    }
    
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .sidebar-section {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    
    .section-title {
      color: #e2e8f0;
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 12px 0;
    }
    
    .participants-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .participant {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    
    .participant:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .participant-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
    }
    
    .participant-name {
      color: #e2e8f0;
      font-weight: 500;
    }
    
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .chat-messages {
      flex: 1;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      overflow-y: auto;
      max-height: 200px;
    }
    
    .chat-message {
      color: #cbd5e1;
      font-size: 14px;
      margin-bottom: 8px;
      padding: 6px 0;
    }
    
    .chat-message.system {
      color: #64748b;
      font-style: italic;
    }
    
    .chat-input-area {
      display: flex;
      gap: 8px;
    }
    
    .chat-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 8px 12px;
      color: white;
      outline: none;
    }
    
    .chat-input::placeholder {
      color: #64748b;
    }
    
    .chat-send {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .controls-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }
    
    .control-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .control-btn.active {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 2px solid #22c55e;
    }
    
    .control-btn.disabled {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 2px solid #ef4444;
    }
    
    .control-btn.neutral {
      background: rgba(255, 255, 255, 0.1);
      color: #e2e8f0;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .control-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    }
    
    .control-btn:active {
      transform: scale(0.95);
    }
    
    .control-btn.active:hover {
      box-shadow: 0 8px 30px rgba(34, 197, 94, 0.3);
    }
    
    .control-btn.disabled:hover {
      box-shadow: 0 8px 30px rgba(239, 68, 68, 0.3);
    }
    
    .control-btn svg {
      width: 24px;
      height: 24px;
    }
    
    .end-call-btn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      width: 64px;
      height: 64px;
    }
    
    .end-call-btn:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
    }
    
    @media (max-width: 768px) {
      .meeting-main {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
      }
      
      .sidebar {
        max-height: 300px;
        overflow-y: auto;
      }
    }
  </style>
</head>
<body>
  <div class="meeting-container">
    <!-- Header -->
    <header class="meeting-header">
      <div class="meeting-info">
        <div class="meeting-code" id="code"></div>
        <h1 class="meeting-title" id="meetingTitle">Meeting Room</h1>
      </div>
      <div class="meeting-actions">
        <button id="copy" class="header-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
            <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" stroke="currentColor" stroke-width="2"/>
          </svg>
          Copy Invite Link
        </button>
        <button class="leave-btn" onclick="window.location.href='/'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9" stroke="currentColor" stroke-width="2"/>
          </svg>
          Leave
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="meeting-main">
      <!-- Video Area -->
      <div class="video-area">
        <video id="localVideo" class="main-video" autoplay muted playsinline style="display:none;"></video>
        <div id="videoPlaceholder" class="video-placeholder" onclick="enableCamera()" style="cursor: pointer;">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="7" width="12" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M15 10l5-3v10l-5-3v-4Z" fill="currentColor"/>
          </svg>
          <h3 style="margin:0; color:#64748b;">Camera is off</h3>
          <p style="margin:0; color:#475569;">Click here or use the camera button to enable your camera</p>
        </div>
        
        <!-- Connection Status Overlay -->
        <div id="connectionStatus" style="position:absolute; top:16px; left:16px; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); color:white; padding:10px 16px; border-radius:25px; font-size:14px; font-weight:500; border:1px solid rgba(255,255,255,0.1);">
          <div class="status-indicator">
            <div class="status-dot connecting" style="width:8px; height:8px; border-radius:50%; background:#f59e0b; margin-right:8px; display:inline-block; animation:pulse 2s infinite;"></div>
            <span>Connecting...</span>
          </div>
        </div>
        
        <!-- Remote Videos Container -->
        <div id="remoteVideos" style="position:absolute; bottom:20px; right:20px; display:flex; flex-wrap:wrap; max-width:400px; gap:10px;"></div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Participants -->
        <div class="sidebar-section">
          <h3 class="section-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline; margin-right:8px;">
              <path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2" stroke="currentColor" stroke-width="2"/>
              <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
              <path d="M22 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" stroke="currentColor" stroke-width="2"/>
            </svg>
            Participants (1)
          </h3>
          <div class="participants-list" id="list">
            <div class="participant">
              <div class="participant-avatar">Y</div>
              <div class="participant-name">You (Host)</div>
            </div>
          </div>
        </div>

        <!-- Chat -->
        <div class="sidebar-section chat-area">
          <h3 class="section-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline; margin-right:8px;">
              <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" stroke="currentColor" stroke-width="2"/>
            </svg>
            Chat
          </h3>
          <div id="chat" class="chat-messages">
            <div class="chat-message system">
              Welcome to the meeting! Share the meeting code to invite others.
            </div>
          </div>
          <div class="chat-input-area">
            <input id="msg" class="chat-input" placeholder="Type a message..." />
            <button id="send" class="chat-send">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 2L2 8.67l6.82 2.73L22 2z" fill="currentColor"/>
                <path d="M8.82 11.4l3.18 8.6L22 2l-13.18 9.4z" fill="currentColor"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </main>

    <div class="controls-bar">
      <button id="btnMic" class="control-btn active" aria-pressed="true" title="Microphone">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 15a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Z" stroke="currentColor" stroke-width="2"/>
          <path d="M5 12a7 7 0 0 0 14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 19v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <button id="btnCam" class="control-btn active" aria-pressed="true" title="Camera">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="7" width="12" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
          <path d="M15 10l5-3v10l-5-3v-4Z" fill="currentColor"/>
        </svg>
      </button>

      <button id="btnScreen" class="control-btn neutral" aria-pressed="false" title="Share Screen">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="5" width="18" height="12" rx="2" stroke="currentColor" stroke-width="2"/>
          <path d="M7 21h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <button class="control-btn end-call-btn" title="End Meeting" onclick="window.location.href='/'">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0017.07 7H18a2 2 0 012 2v9a2 2 0 01-2 2H6a2 2 0 01-2-2V9z" stroke="currentColor" stroke-width="2"/>
          <path d="M15 13l-6-6" stroke="currentColor" stroke-width="2"/>
          <path d="M9 13l6-6" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    function getCode(){
      const p = new URLSearchParams(location.search);
      return (p.get('code')||'').toUpperCase();
    }
    function getUrlParam(param){ 
      const p = new URLSearchParams(location.search);
      return p.get(param);
    }
    function setCode(c){ $('code').textContent = c ? `#${c}` : '(no code)'; }
    function randomCode(){ return Math.random().toString(36).slice(2, 8).toUpperCase(); }

    // Initialize Socket.IO connection
    const socket = io();
    let currentMeetingCode = null;
    let currentUserInfo = {
      name: getUrlParam('user') || 'Anonymous User',
      isAnonymous: !getUrlParam('user'),
      userId: Math.random().toString(36).substr(2, 9)
    };

    async function mount(){
      const code = getCode() || randomCode();
      if (!getCode()) {
        const url = new URL(location.href);
        url.searchParams.set('code', code);
        history.replaceState(null, '', url);
      }
      setCode(code);

      // Join this meeting via API
      await joinThisMeeting(code);

      loadMeetingDetails(code);

      const meetingSettings = JSON.parse(localStorage.getItem('meetingSettings') || '{}');
      if (meetingSettings.enableVideo === false) {
        const btnCam = $('btnCam');
        if (btnCam) toggle(btnCam);
      } 
      if (meetingSettings.enableAudio === false) {
        const btnMic = $('btnMic');
        if (btnMic) toggle(btnMic);
      }

      setTimeout(() => {
        addChatMessage('system', '🎉 Meeting room ready! Share your code to invite others.');
        showNotification('Meeting Joined', 'You are now in the meeting');
      }, 1000);
      
      startParticipantPolling(code);
      
      setupLeaveHandlers(code);
    }
    
    function setupLeaveHandlers(code) {

      window.addEventListener('beforeunload', () => {
        leaveMeeting(code);
      });
      
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
         
          setTimeout(() => {
            if (document.visibilityState === 'hidden') {
              leaveMeeting(code);
            }
          }, 30000); 
        }
      });
    }
    
    function leaveMeeting(code) {
      const session = JSON.parse(localStorage.getItem('currentSession') || '{}');
      
      
      if (navigator.sendBeacon) {
        navigator.sendBeacon('/api/meeting/leave', JSON.stringify({
          meeting_code: code,
          session_id: session.session_id,
          anonymous_name: 'Anonymous User'
        }));
      } else {
      
        fetch('/api/meeting/leave', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            meeting_code: code,
            session_id: session.session_id,
            anonymous_name: 'Anonymous User'
          }),
          keepalive: true
        }).catch(() => {
          
        });
      }
      
      localStorage.removeItem('currentSession');
    }
    
    async function joinThisMeeting(code) {
      try {
        // First, join via HTTP API to ensure meeting exists and add to database
        const response = await fetch('/api/meeting/join', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            meeting_code: code,
            anonymous_name: currentUserInfo.name,
            session_id: currentUserInfo.userId
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          console.log('✅ Successfully joined meeting via API:', result.meeting);
          
          // Store session info
          localStorage.setItem('currentSession', JSON.stringify({
            session_id: currentUserInfo.userId,
            meeting_code: code,
            joined_at: new Date().toISOString()
          }));
          
          // Now join the real-time Socket.IO room
          currentMeetingCode = code;
          socket.emit('join-meeting', {
            meetingCode: code,
            userInfo: {
              id: currentUserInfo.userId,
              name: currentUserInfo.name,
              avatar: currentUserInfo.name.charAt(0).toUpperCase(),
              isHost: false,
              isAnonymous: currentUserInfo.isAnonymous
            }
          });
          
        } else {
          console.error('❌ Failed to join meeting:', result.error);
          showNotification('Join Failed', result.error || 'Unable to join the meeting');
          
          const statusElement = $('connectionStatus');
          if (statusElement) {
            statusElement.innerHTML = `
              <div class="status-indicator">
                <div class="status-dot disconnected" style="width:8px; height:8px; border-radius:50%; background:#ef4444; margin-right:8px; display:inline-block;"></div>
                <span>Failed to join: ${result.error}</span>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('❌ Network error joining meeting:', error);
        showNotification('Connection Error', 'Failed to connect to meeting server');
        
        const statusElement = $('connectionStatus');
        if (statusElement) {
          statusElement.innerHTML = `
            <div class="status-indicator">
              <div class="status-dot disconnected" style="width:8px; height:8px; border-radius:50%; background:#ef4444; margin-right:8px; display:inline-block;"></div>
              <span>Connection failed - check network</span>
            </div>
          `;
        }
      }
    }
    
    let participantPollInterval = null;

    // Socket.IO Event Listeners for real-time communication
    socket.on('meeting-joined', (data) => {
      console.log('🎉 Joined meeting successfully:', data);
      showNotification('Meeting Joined', `Welcome to ${data.meeting.title}!`);
      
      // Load chat history if available
      if (data.chatHistory && data.chatHistory.length > 0) {
        data.chatHistory.forEach(msg => {
          if (msg.isSystem) {
            addChatMessage('system', msg.message);
          } else {
            addChatMessageRealtime(msg.sender, msg.message, msg.timestamp, msg.isAnonymous);
          }
        });
      }
      
      // Update status indicator
      const statusElement = $('connectionStatus');
      if (statusElement) {
        statusElement.innerHTML = `
          <div class="status-indicator">
            <div class="status-dot connected" style="width:8px; height:8px; border-radius:50%; background:#22c55e; margin-right:8px; display:inline-block;"></div>
            <span>Connected • ${data.meeting.meeting_code} • ${data.participantCount} participants</span>
          </div>
        `;
      }
    });

    socket.on('participants-update', (data) => {
      console.log('👥 Received participants list:', data.participants);
      updateParticipantsListRealtime(data.participants);
    });

    socket.on('participant-joined', (data) => {
      console.log('👋 New participant joined:', data.participant.name);
      showNotification('Participant Joined', `${data.participant.name} joined the meeting`);
      
      // Update participant count in status
      const statusElement = $('connectionStatus');
      if (statusElement && currentMeetingCode) {
        statusElement.innerHTML = `
          <div class="status-indicator">
            <div class="status-dot connected" style="width:8px; height:8px; border-radius:50%; background:#22c55e; margin-right:8px; display:inline-block;"></div>
            <span>Connected • ${currentMeetingCode} • ${data.participantCount} participants</span>
          </div>
        `;
      }
    });

    socket.on('participant-left', (data) => {
      console.log('👋 Participant left:', data.participant.name);
      showNotification('Participant Left', `${data.participant.name} left the meeting`);
      
      // Update participant count in status
      const statusElement = $('connectionStatus');
      if (statusElement && currentMeetingCode) {
        statusElement.innerHTML = `
          <div class="status-indicator">
            <div class="status-dot connected" style="width:8px; height:8px; border-radius:50%; background:#22c55e; margin-right:8px; display:inline-block;"></div>
            <span>Connected • ${currentMeetingCode} • ${data.participantCount} participants</span>
          </div>
        `;
      }
    });

    socket.on('chat-message', (data) => {
      console.log('💬 Received chat message:', data);
      addChatMessageRealtime(data.sender, data.message, data.timestamp, data.isAnonymous);
    });

    socket.on('participant-media-update', (data) => {
      console.log('🎥 Participant media state changed:', data);
      // Update participant media indicators in the UI
      updateParticipantMediaState(data.participantId, data.participantName, data.mediaState);
    });

    socket.on('screen-share-update', (data) => {
      console.log('📺 Screen share update:', data);
      showNotification('Screen Share', 
        data.sharing ? `${data.participantName} started sharing` : `${data.participantName} stopped sharing`);
    });

    socket.on('meeting-error', (data) => {
      console.error('❌ Meeting error:', data);
      showNotification('Meeting Error', data.message);
    });

    socket.on('error', (data) => {
      console.error('❌ Socket error:', data);
      showNotification('Error', data.message);
    });

    socket.on('disconnect', () => {
      console.log('🔌 Disconnected from server');
      showNotification('Disconnected', 'Connection to server lost');
      
      const statusElement = $('connectionStatus');
      if (statusElement) {
        statusElement.innerHTML = `
          <div class="status-indicator">
            <div class="status-dot disconnected" style="width:8px; height:8px; border-radius:50%; background:#ef4444; margin-right:8px; display:inline-block;"></div>
            <span>Disconnected - trying to reconnect...</span>
          </div>
        `;
      }
    });

    socket.on('reconnect', () => {
      console.log('🔌 Reconnected to server');
      showNotification('Reconnected', 'Connection restored');
      
      // Rejoin the meeting if we were in one
      if (currentMeetingCode) {
        socket.emit('join-meeting', {
          meetingCode: currentMeetingCode,
          userInfo: currentUserInfo
        });
      }
    });
    
    function startParticipantPolling(code) {
      if (participantPollInterval) {
        clearInterval(participantPollInterval);
      }
      
    
      participantPollInterval = setInterval(async () => {
        try {
          const response = await fetch(`/api/meeting/${code}`);
          const result = await response.json();
          
          if (result.success && result.meeting) {
            console.log('Fetched meeting data:', result.meeting);
            updateParticipantsList(result.meeting.participants || []);
            
            const statusElement = $('connectionStatus');
            if (statusElement && result.meeting.status === 'active') {
              statusElement.innerHTML = `
                <div class="status-indicator">
                  <div class="status-dot connected" style="width:8px; height:8px; border-radius:50%; background:#22c55e; margin-right:8px; display:inline-block;"></div>
                  <span>Connected • ${code} • ${result.meeting.participants ? result.meeting.participants.length : 0} participants</span>
                </div>
              `;
            }
          } else {
            console.log('Meeting not found or inactive:', result);
            if (!result.success && result.error === 'Meeting not found') {
              showNotification('Meeting Ended', 'This meeting has ended or been removed');
              clearInterval(participantPollInterval);
            }
          }
        } catch (error) {
          console.log('Polling error:', error.message);
          
        }
      }, 3000);
      
      setTimeout(() => {
        fetch(`/api/meeting/${code}`)
          .then(response => response.json())
          .then(result => {
            if (result.success && result.meeting) {
              updateParticipantsList(result.meeting.participants || []);
            }
          })
          .catch(error => console.log('Initial poll error:', error));
      }, 500);
    }
    
    function updateParticipantsList(participants) {
      const list = $('list');
      if (!list) return;
      
      console.log('Updating participants list:', participants);
      
      list.innerHTML = '';
      
      const titleElement = document.querySelector('.section-title');
      if (titleElement && titleElement.textContent.includes('Participants')) {
        titleElement.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline; margin-right:8px;">
            <path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2" stroke="currentColor" stroke-width="2"/>
            <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
            <path d="M22 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" stroke="currentColor" stroke-width="2"/>
          </svg>
          Participants (${participants.length || 0})
        `;
      }
      
      // Add participants to list
      if (participants && participants.length > 0) {
        participants.forEach((participant, index) => {
          addParticipant(participant.name || 'Anonymous User', index === 0, participant.is_anonymous);
        });
      } else {
        addParticipant('You (Host)', true, false);
      }
    }

    function addParticipant(name, isHost = false, isAnonymous = true) {
      const list = $('list');
      if (!list) return;
      
      const participantElement = document.createElement('div');
      participantElement.className = 'participant';
      
      const avatar = name.charAt(0).toUpperCase();
      const statusIndicator = isHost ? ' (Host)' : '';
      
      participantElement.innerHTML = `
        <div class="participant-avatar" style="
          background: linear-gradient(135deg, #3b82f6, #8b5cf6);
          color: white;
          width: 32px;
          height: 32px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 600;
          font-size: 14px;
          margin-right: 12px;
        ">${avatar}</div>
        <div class="participant-info" style="flex: 1;">
          <div class="participant-name" style="font-weight: 500; color: rgba(255, 255, 255, 0.9);">
            ${name}${statusIndicator}
          </div>
          <div class="participant-status" style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">
            ${isAnonymous ? 'Guest' : 'Member'} • Online
          </div>
        </div>
        <div class="participant-controls" style="display: flex; gap: 4px;">
          <div style="
            width: 6px;
            height: 6px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
          " title="Audio enabled"></div>
          <div style="
            width: 6px;
            height: 6px;
            background: #3b82f6;
            border-radius: 50%;
            animation: pulse 2s infinite;
          " title="Video enabled"></div>
        </div>
      `;
      
      participantElement.style.opacity = '0';
      participantElement.style.transform = 'translateX(-10px)';
      participantElement.style.transition = 'all 0.3s ease';
      
      list.appendChild(participantElement);
      
      setTimeout(() => {
        participantElement.style.opacity = '1';
        participantElement.style.transform = 'translateX(0)';
      }, 50);
    }

    function updateParticipantsListRealtime(participants) {
      const list = $('list');
      if (!list) return;
      
      console.log('Updating participants list (real-time):', participants);
      
      list.innerHTML = '';
      
      const titleElement = document.querySelector('.section-title');
      if (titleElement && titleElement.textContent.includes('Participants')) {
        titleElement.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline; margin-right:8px;">
            <path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2" stroke="currentColor" stroke-width="2"/>
            <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
            <path d="M22 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" stroke="currentColor" stroke-width="2"/>
          </svg>
          Participants (${participants.length})
        `;
      }
      
      participants.forEach((participant) => {
        const isCurrentUser = participant.socketId === socket.id || participant.name === currentUserInfo.name;
        addParticipantRealtime(participant, isCurrentUser);
      });
    }

    function addParticipantRealtime(participant, isCurrentUser = false) {
      const list = $('list');
      if (!list) return;
      
      const participantElement = document.createElement('div');
      participantElement.className = 'participant';
      participantElement.id = `participant-${participant.socketId}`;
      
      const avatar = participant.name.charAt(0).toUpperCase();
      const statusIndicator = isCurrentUser ? ' (You)' : '';
      
      participantElement.innerHTML = `
        <div class="participant-avatar" style="
          background: linear-gradient(135deg, ${isCurrentUser ? '#22c55e, #16a34a' : '#3b82f6, #8b5cf6'});
          color: white;
          width: 32px;
          height: 32px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 600;
          font-size: 14px;
          margin-right: 12px;
        ">${avatar}</div>
        <div class="participant-info" style="flex: 1;">
          <div class="participant-name" style="font-weight: 500; color: rgba(255, 255, 255, 0.9);">
            ${participant.name}${statusIndicator}
          </div>
          <div class="participant-status" style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">
            ${participant.isAnonymous ? 'Guest' : 'Member'} • Online
          </div>
        </div>
        <div class="participant-controls" id="media-${participant.socketId}" style="display: flex; gap: 4px;">
          <div class="media-indicator audio-indicator" style="
            width: 6px;
            height: 6px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
          " title="Audio enabled"></div>
          <div class="media-indicator video-indicator" style="
            width: 6px;
            height: 6px;
            background: #3b82f6;
            border-radius: 50%;
            animation: pulse 2s infinite;
          " title="Video enabled"></div>
        </div>
      `;
      
      participantElement.style.opacity = '0';
      participantElement.style.transform = 'translateX(-10px)';
      participantElement.style.transition = 'all 0.3s ease';
      
      list.appendChild(participantElement);
      
      setTimeout(() => {
        participantElement.style.opacity = '1';
        participantElement.style.transform = 'translateX(0)';
      }, 50);
    }

    function updateParticipantMediaState(participantId, participantName, mediaState) {
      const mediaControls = $(`media-${participantId}`);
      if (!mediaControls) return;
      
      const audioIndicator = mediaControls.querySelector('.audio-indicator');
      const videoIndicator = mediaControls.querySelector('.video-indicator');
      
      if (audioIndicator) {
        audioIndicator.style.background = mediaState.audio ? '#22c55e' : '#ef4444';
        audioIndicator.title = mediaState.audio ? 'Audio enabled' : 'Audio disabled';
      }
      
      if (videoIndicator) {
        videoIndicator.style.background = mediaState.video ? '#3b82f6' : '#ef4444';
        videoIndicator.title = mediaState.video ? 'Video enabled' : 'Video disabled';
      }
    }
    
    function addChatMessage(type, message) {
      const chat = $('chat');
      const line = document.createElement('div');
      line.className = `chat-message ${type}`;
      line.innerHTML = message;
      line.style.opacity = '0';
      line.style.transform = 'translateY(10px)';
      line.style.transition = 'all 0.3s ease';
      
      chat.appendChild(line);
      
      requestAnimationFrame(() => {
        line.style.opacity = '1';
        line.style.transform = 'translateY(0)';
      });
      
      chat.scrollTop = chat.scrollHeight;
    }

    function addChatMessageRealtime(sender, message, timestamp, isAnonymous) {
      const chat = $('chat');
      const line = document.createElement('div');
      line.className = 'chat-message user';
      
      const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const isCurrentUser = sender === currentUserInfo.name;
      
      line.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
          <span style="font-weight: 500; color: ${isCurrentUser ? '#22c55e' : '#3b82f6'};">
            ${sender}${isCurrentUser ? ' (You)' : ''}
          </span>
          <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">${time}</span>
        </div>
        <div style="color: rgba(255, 255, 255, 0.9); line-height: 1.4;">${message}</div>
      `;
      
      line.style.opacity = '0';
      line.style.transform = 'translateY(10px)';
      line.style.transition = 'all 0.3s ease';
      
      chat.appendChild(line);
      requestAnimationFrame(() => {
        line.style.opacity = '1';
        line.style.transform = 'translateY(0)';
      });
      
      chat.scrollTop = chat.scrollHeight;
    }
    
    function addParticipant(name, isHost = false, isAnonymous = true) {
      const list = $('list');
      const participant = document.createElement('div');
      participant.className = 'participant';
      
      const avatar = name.charAt(0).toUpperCase();
      const displayName = name || 'Anonymous User';
      const roleText = isHost ? ' (Host)' : (isAnonymous ? ' (Guest)' : '');
      
      participant.innerHTML = `
        <div class="participant-avatar" style="background: ${getAvatarColor(name)}">${avatar}</div>
        <div class="participant-name">${displayName}${roleText}</div>
      `;
      participant.style.opacity = '0';
      participant.style.transform = 'translateX(-20px)';
      participant.style.transition = 'all 0.3s ease';
      
      list.appendChild(participant);
      
      requestAnimationFrame(() => {
        participant.style.opacity = '1';
        participant.style.transform = 'translateX(0)';
      });
    }
    
    function getAvatarColor(name) {
      const colors = [
        'linear-gradient(135deg, #3b82f6, #8b5cf6)',
        'linear-gradient(135deg, #ef4444, #f97316)',
        'linear-gradient(135deg, #10b981, #059669)',
        'linear-gradient(135deg, #8b5cf6, #ec4899)',
        'linear-gradient(135deg, #06b6d4, #3b82f6)',
        'linear-gradient(135deg, #f59e0b, #ef4444)'
      ];
      
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      
      return colors[Math.abs(hash) % colors.length];
    }
    
    function showNotification(title, message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(10px);
        color: white;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 1000;
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 300px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      `;
      
      notification.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px;">${title}</div>
        <div style="font-size: 14px; opacity: 0.8;">${message}</div>
      `;
      
      document.body.appendChild(notification);
      
      requestAnimationFrame(() => {
        notification.style.transform = 'translateX(0)';
      });
      
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    async function loadMeetingDetails(code) {
      try {
        const response = await fetch(`/api/meeting/${code}`);
        const result = await response.json();

        if (result.success && result.meeting) {
          const meeting = result.meeting;
          
          // Update meeting title
          const titleElement = $('meetingTitle');
          if (titleElement) {
            titleElement.textContent = meeting.title;
          }
          
          const settings = meeting.settings || {};
          if (settings.enableVideo === false) {
            const btnCam = $('btnCam');
            if (btnCam) toggle(btnCam);
          }
          if (settings.enableAudio === false) {
            const btnMic = $('btnMic');
            if (btnMic) toggle(btnMic);
          }
          
          console.log('Meeting loaded:', meeting);
        } else {
          console.log('Meeting not found, creating new session');
          
          const meetingSettings = JSON.parse(localStorage.getItem('meetingSettings') || '{}');
          const titleElement = $('meetingTitle');
          if (titleElement && meetingSettings.title) {
            titleElement.textContent = meetingSettings.title;
          }
        }
      } catch (error) {
        console.error('Error loading meeting details:', error);
        
        const meetingSettings = JSON.parse(localStorage.getItem('meetingSettings') || '{}');
        const titleElement = $('meetingTitle');
        if (titleElement && meetingSettings.title) {
          titleElement.textContent = meetingSettings.title;
        }
      }
        const btnCam = $('btnCam');
        if (btnCam) toggle(btnCam);
      }
      if (meetingSettings.enableAudio === false) {
        const btnMic = $('btnMic');
        if (btnMic) toggle(btnMic);
      }

      setTimeout(() => {
        const statusElement = $('connectionStatus');
        if (statusElement) {
          statusElement.innerHTML = `
            <div class="status-indicator">
              <div class="status-dot connected" style="width:8px; height:8px; border-radius:50%; background:#22c55e; margin-right:8px; display:inline-block;"></div>
              <span>Connected • ${code}</span>
            </div>
          `;
        }
      }, 1500);

      let localStream = null;
      let webrtcClient = null;
      
      // Enable video and audio by default unless explicitly disabled
      let isVideoEnabled = meetingSettings.enableVideo !== false;
      let isAudioEnabled = meetingSettings.enableAudio !== false;
      
      // Force video to be enabled if no settings exist
      if (typeof meetingSettings.enableVideo === 'undefined') {
        isVideoEnabled = true;
      }

      async function initializeMedia() {
        try {
          console.log('🎥 Initializing media with video:', isVideoEnabled, 'audio:', isAudioEnabled);
          
          const constraints = {
            video: isVideoEnabled,
            audio: isAudioEnabled
          };

          // Initialize WebRTC client if not already done
          if (!webrtcClient) {
            const localVideo = $('localVideo');
            const remoteVideos = $('remoteVideos');
            webrtcClient = new HangOWebRTC(socket, localVideo, remoteVideos);
          }
          
          // Initialize media through WebRTC client
          localStream = await webrtcClient.initializeMedia(constraints);
          console.log('✅ Media stream obtained via WebRTC client');
          
          const placeholder = $('videoPlaceholder');
          if (placeholder) {
            if (isVideoEnabled && localStream.getVideoTracks().length > 0) {
              placeholder.style.display = 'none';
              console.log('📹 Local video enabled and displayed');
            } else {
              placeholder.style.display = 'flex';
              console.log('📺 Video placeholder shown');
            }
          }

          updateControlStates();
          
        } catch (error) {
          console.error('❌ Error accessing media devices:', error);
          showMediaError(error);
        }
      }

      function enableCamera() {
        const btnCam = $('btnCam');
        if (btnCam && btnCam.getAttribute('aria-pressed') === 'false') {
          console.log('🎥 Enabling camera via placeholder click');
          toggle(btnCam);
        } else if (!localStream) {
          console.log('🎥 No stream exists, initializing media...');
          isVideoEnabled = true;
          initializeMedia();
        }
      }

      function showMediaError(error) {
        let message = 'Unable to access camera or microphone. ';
        
        if (error.name === 'NotAllowedError') {
          message += 'Please allow camera and microphone permissions in your browser settings.';
        } else if (error.name === 'NotFoundError') {
          message += 'No camera or microphone device found.';
        } else if (error.name === 'NotReadableError') {
          message += 'Camera or microphone is already in use by another application.';
        } else {
          message += error.message || 'Unknown error occurred.';
        }
        
        // Show error in the video placeholder
        const placeholder = $('videoPlaceholder');
        if (placeholder) {
          placeholder.innerHTML = `
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" stroke="#ef4444" stroke-width="2"/>
              <line x1="15" y1="9" x2="9" y2="15" stroke="#ef4444" stroke-width="2"/>
              <line x1="9" y1="9" x2="15" y2="15" stroke="#ef4444" stroke-width="2"/>
            </svg>
            <h3 style="margin:0; color:#ef4444;">Camera Error</h3>
            <p style="margin:0; color:#94a3b8; font-size:14px; max-width:300px;">${message}</p>
            <button onclick="initializeMedia()" style="margin-top:12px; padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer;">Try Again</button>
          `;
        }
        
        showNotification('Media Error', message);
      }

      function updateControlStates() {
        const btnMic = $('btnMic');
        const btnCam = $('btnCam');
        
        if (btnMic) {
          btnMic.setAttribute('aria-pressed', isAudioEnabled);
          btnMic.classList.toggle('disabled', !isAudioEnabled);
        }
        
        if (btnCam) {
          btnCam.setAttribute('aria-pressed', isVideoEnabled);
          btnCam.classList.toggle('disabled', !isVideoEnabled);
        }
      }

      function showMediaError(error) {
        const statusElement = $('connectionStatus');
        if (statusElement) {
          let errorMessage = 'Unable to access camera/microphone';
          if (error.name === 'NotAllowedError') {
            errorMessage = 'Camera/microphone access denied. Please allow permissions and refresh the page.';
          } else if (error.name === 'NotFoundError') {
            errorMessage = 'No camera/microphone found. Please connect a device.';
          } else if (error.name === 'NotReadableError') {
            errorMessage = 'Camera/microphone is already in use by another application.';
          }
          
          statusElement.innerHTML = `
            <div class="status-indicator">
              <div class="status-dot disconnected"></div>
              <span>${errorMessage}</span>
            </div>
          `;
        }
        
        showNotification('Media Error', errorMessage);
      }
      
      function showNotification(title, message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(30, 41, 59, 0.95);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 12px;
          padding: 16px 20px;
          color: white;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          font-size: 14px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          max-width: 320px;
          transform: translateX(100%);
          transition: transform 0.3s ease;
        `;
        
        notification.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 4px;">${title}</div>
          <div style="opacity: 0.8;">${message}</div>
        `;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
          notification.style.transform = 'translateX(0)';
        }, 50);
        setTimeout(() => {
          notification.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 4000);
      }

      // Screen sharing functionality
      let screenStream = null;
      
      async function startScreenShare(btn) {
        try {
          console.log('🖥️ Starting screen share via WebRTC');
          
          let success = false;
          if (webrtcClient) {
            success = await webrtcClient.startScreenShare();
          }
          
          if (success) {
            // Update button state
            btn.classList.remove('neutral');
            btn.classList.add('active');
            btn.innerHTML = `
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="3" y="4" width="18" height="12" rx="2" stroke="currentColor" stroke-width="2"/>
                <path d="M8 21h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 17v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <circle cx="12" cy="10" r="2" fill="currentColor"/>
              </svg>
            `;
            
            // Broadcast screen share start
            if (currentMeetingCode) {
              socket.emit('screen-share', { action: 'start' });
            }
            
            showNotification('Screen Sharing', 'Your screen is now being shared');
            console.log('✅ Screen sharing started successfully');
          } else {
            throw new Error('Screen sharing failed');
          }
          
        } catch (error) {
          console.error('❌ Error starting screen share:', error);
          btn.setAttribute('aria-pressed', 'false');
          btn.classList.remove('active');
          btn.classList.add('neutral');
          
          if (error.name === 'NotAllowedError') {
            showNotification('Screen Share Denied', 'Screen sharing permission was denied');
          } else {
            showNotification('Screen Share Error', 'Unable to start screen sharing: ' + error.message);
          }
        }
      }
      
      async function stopScreenShare(btn) {
        try {
          console.log('🖥️ Stopping screen share via WebRTC');
          
          if (webrtcClient) {
            await webrtcClient.stopScreenShare();
          }
          
          // Update button state
          btn.classList.remove('active');
          btn.classList.add('neutral');
          btn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="4" width="18" height="12" rx="2" stroke="currentColor" stroke-width="2"/>
              <path d="M8 21h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 17v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          `;
          
          // Broadcast screen share stop
          if (currentMeetingCode) {
            socket.emit('screen-share', { action: 'stop' });
          }
          
          showNotification('Screen Sharing Stopped', 'You are no longer sharing your screen');
          console.log('✅ Screen sharing stopped successfully');
          
        } catch (error) {
          console.error('❌ Error stopping screen share:', error);
          showNotification('Error', 'Failed to stop screen sharing properly');
        }
      }

      // Cleanup function for leaving meeting
      function leaveMeeting() {
        console.log('👋 Leaving meeting - cleaning up WebRTC connections');
        
        if (webrtcClient) {
          webrtcClient.cleanup();
        }
        
        if (socket) {
          socket.emit('leave-meeting');
        }
        
        // Redirect to dashboard
        window.location.href = '/dashboard.html';
      }
      
      // Add event listener for page unload
      window.addEventListener('beforeunload', () => {
        if (webrtcClient) {
          webrtcClient.cleanup();
        }
      });

      // Initialize media when page loads
      initializeMedia();
      
      // Add keyboard shortcut for copying link (Ctrl+C or Cmd+C)
      document.addEventListener('keydown', (event) => {
        if ((event.ctrlKey || event.metaKey) && event.key === 'c' && !event.target.matches('input, textarea')) {
          event.preventDefault();
          $('copy').click();
        }
      });

      $('copy').onclick = async () => {
        const code = getCode();
        const meetingTitle = getUrlParam('title') || 'HangO Meeting';
        const meetingUrl = `${location.origin}/?join=${encodeURIComponent(code)}`;
        
        // Create a comprehensive invite message
        const inviteMessage = `🎉 Join my HangO meeting!

📝 Meeting: ${meetingTitle}
🔑 Meeting Code: ${code}
🔗 Direct Link: ${meetingUrl}

💡 How to join:
• Click the direct link above, OR
• Go to ${location.origin} and enter code: ${code}

See you there! 👋`;
        
        try { 
          await navigator.clipboard.writeText(meetingUrl);
          
          // Update button to show success
          $('copy').innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2"/>
            </svg>
            Link Copied!
          `;
          $('copy').style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
          $('copy').style.color = 'white';
          $('copy').style.transform = 'scale(1.05)';
          
          showNotification('Invite Link Copied!', 'Share this link with others to join the meeting');
          
          // Also show the full invite message in console for easy access
          console.log('Full invite message (for manual sharing):');
          console.log(inviteMessage);
          
        } catch (error) {
          console.error('Clipboard error:', error);
          
          // Fallback: try to copy the full invite message
          try {
            await navigator.clipboard.writeText(inviteMessage);
            showNotification('Invite Message Copied!', 'Full invitation copied to clipboard');
          } catch {
            // Final fallback: show the information
            showNotification('Share Meeting', `Meeting Code: ${code}\nLink: ${meetingUrl}`);
            
            // Create a temporary text area to select text for manual copying
            const textArea = document.createElement('textarea');
            textArea.value = meetingUrl;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            setTimeout(() => {
              document.body.removeChild(textArea);
            }, 100);
          }
        }
        
        // Reset button after 3 seconds
        setTimeout(() => {
          $('copy').innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
              <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" stroke="currentColor" stroke-width="2"/>
            </svg>
            Copy Invite Link
          `;
          $('copy').style.background = '';
          $('copy').style.color = '';
          $('copy').style.transform = '';
        }, 3000);
      };

      const chat = $('chat');
      $('send').onclick = () => {
        const v = $('msg').value.trim();
        if (!v) return;
        
        // Send message via Socket.IO
        if (currentMeetingCode) {
          socket.emit('chat-message', { message: v });
          $('msg').value = '';
        } else {
          showNotification('Error', 'Not connected to meeting');
        }
        
        // Add typing indicator simulation (fun feature)
        setTimeout(() => {
          const typingLine = document.createElement('div');
          typingLine.className = 'chat-message system';
          typingLine.innerHTML = `<em style="color:#64748b;">Others are typing...</em>`;
          typingLine.style.opacity = '0.7';
          chat.appendChild(typingLine);
          chat.scrollTop = chat.scrollHeight;
          
          setTimeout(() => {
            if (typingLine.parentNode) {
              typingLine.remove();
            }
          }, 2000);
        }, 1000);
      };
      
      // Add Enter key support for chat
      $('msg').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          $('send').click();
        }
      });

      // Left panel interactions (simulated preview + audio meter)
      const btnMic = $('btnMic');
      const btnCam = $('btnCam');
      const btnScreen = $('btnScreen');
      const meter = $('meter');
      const mctx = meter.getContext('2d');
      function resizeMeter(){
        const DPR = Math.min(2, window.devicePixelRatio||1);
        meter.width = meter.clientWidth * DPR; meter.height = meter.clientHeight * DPR; mctx.setTransform(DPR,0,0,DPR,0,0);
      }
      resizeMeter();
      window.addEventListener('resize', resizeMeter);

      function drawMeter(level){
        const w = meter.width / (window.devicePixelRatio||1), h = meter.height / (window.devicePixelRatio||1);
        mctx.clearRect(0,0,w,h);
        mctx.fillStyle = 'rgba(148,163,184,.25)';
        mctx.fillRect(0,0,w,h);
        const grad = mctx.createLinearGradient(0,0,w,0);
        grad.addColorStop(0,'#22d3ee'); grad.addColorStop(.5,'#a78bfa'); grad.addColorStop(1,'#f472b6');
        mctx.fillStyle = grad; mctx.fillRect(2,2,(w-4)*level, h-4);
      }
      let t = 0; function tick(){ t+=0.08; const lv = 0.15 + (Math.sin(t)+1)/2 * 0.75; drawMeter(lv); requestAnimationFrame(tick); } tick();

      function toggle(btn){
        const isPressed = btn.getAttribute('aria-pressed') === 'true';
        const newState = !isPressed;
        btn.setAttribute('aria-pressed', String(newState));
        
        // Update button styling based on new state
        btn.classList.remove('active', 'disabled', 'neutral');
        if (newState) {
          btn.classList.add('active');
        } else {
          btn.classList.add('disabled');
        }
        
        // Handle actual media stream controls
        if (btn.id === 'btnMic') {
          // Use WebRTC client for audio toggle
          if (webrtcClient) {
            isAudioEnabled = webrtcClient.toggleAudio();
          } else if (localStream) {
            const audioTracks = localStream.getAudioTracks();
            audioTracks.forEach(track => track.enabled = newState);
            isAudioEnabled = newState;
          }
          
          // Broadcast media state change
          if (currentMeetingCode) {
            socket.emit('media-toggle', {
              type: 'audio',
              enabled: isAudioEnabled
            });
          }
          
          // Add visual feedback for mic mute/unmute
          if (!newState) {
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 15a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Z" stroke="currentColor" stroke-width="2"/>
              <path d="M5 12a7 7 0 0 0 14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 19v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"/>
            </svg>`;
          } else {
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 15a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Z" stroke="currentColor" stroke-width="2"/>
              <path d="M5 12a7 7 0 0 0 14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 19v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>`;
          }
        } else if (btn.id === 'btnCam') {
          if (!localStream && newState) {
            // If no stream exists and we're trying to enable video, initialize media
            console.log('🎥 No stream exists, initializing media for video...');
            initializeMedia();
            return;
          }
          
          // Use WebRTC client for video toggle
          if (webrtcClient) {
            isVideoEnabled = webrtcClient.toggleVideo();
          } else if (localStream) {
            const videoTracks = localStream.getVideoTracks();
            videoTracks.forEach(track => track.enabled = newState);
            isVideoEnabled = newState;
            
            const localVideo = $('localVideo');
            const placeholder = $('videoPlaceholder');
            if (localVideo && placeholder) {
              if (newState) {
                localVideo.style.display = 'block';
                placeholder.style.display = 'none';
              } else {
                localVideo.style.display = 'none';
                placeholder.style.display = 'flex';
              }
            }
          }
          
          // Broadcast media state change
          if (currentMeetingCode) {
            socket.emit('media-toggle', {
              type: 'video',
              enabled: isVideoEnabled
            });
          }
          
          // Update camera icon
          if (!newState) {
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="7" width="12" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
              <path d="M15 10l5-3v10l-5-3v-4Z" fill="currentColor"/>
              <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"/>
            </svg>`;
          } else {
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="7" width="12" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
              <path d="M15 10l5-3v10l-5-3v-4Z" fill="currentColor"/>
            </svg>`;
          }
        } else if (btn.id === 'btnScreen') {
          // Screen share functionality
          if (newState) {
            startScreenShare(btn);
          } else {
            stopScreenShare(btn);
          }
        }
      }
      btnMic.onclick = ()=> toggle(btnMic);
      btnCam.onclick = ()=> toggle(btnCam);
      btnScreen.onclick = ()=> toggle(btnScreen);
    
    mount();
  </script>
</body>
</html>
