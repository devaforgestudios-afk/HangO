<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HangO - Auth</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    /* Forgot Password Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 24px 0 24px;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: #1f2937;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-body p {
      margin-bottom: 20px;
      color: #6b7280;
      line-height: 1.5;
    }

    .forgot-message {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
    }

    .forgot-message.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .forgot-message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .forgot-message:empty {
      display: none;
    }
  </style>
</head>
<body>
  <header class="nav nav--dock">
    <div class="container">
      <div class="nav-dock">
        <a href="/" class="brand" aria-label="HangO home">
          <svg class="logo-mark" width="34" height="34" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g1a" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#22d3ee"/>
              <stop offset="50%" stop-color="#a78bfa"/>
              <stop offset="100%" stop-color="#f472b6"/>
            </linearGradient>
          </defs>
          <rect x="4" y="8" width="40" height="32" rx="10" stroke="url(#g1a)" stroke-width="3"/>
          <circle cx="16" cy="24" r="6" fill="url(#g1a)"/>
          <circle cx="32" cy="24" r="6" stroke="url(#g1a)" stroke-width="3" fill="none"/>
          </svg>
          <span class="brand__name text-gradient">HangO</span>
        </a>
        <button class="nav-toggle" aria-label="Open menu" aria-expanded="false" aria-controls="navMenu">
          <span></span><span></span><span></span>
        </button>
        <nav id="navMenu" class="nav-menu">
          <a class="nav-link" href="/">Home</a>
          <a class="nav-link" href="/auth.html">Account</a>
          <div class="nav-split"></div>
          
          <a href="/auth.html" class="btn btn--neon">Get started</a>
        </nav>
      </div>
    </div>
  </header>


  <div class="auth-layout">
    <!-- Left Panel - Form -->
    <div class="auth-form-panel">
      <div class="auth-form-container">
        <!-- Brand Header -->
        <div class="brand-header">
          <svg class="brand-logo" width="40" height="40" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="brandGrad" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#0066ff"/>
                <stop offset="100%" stop-color="#0052cc"/>
              </linearGradient>
            </defs>
            <rect x="4" y="8" width="40" height="32" rx="10" stroke="url(#brandGrad)" stroke-width="3"/>
            <circle cx="16" cy="24" r="6" fill="url(#brandGrad)"/>
            <circle cx="32" cy="24" r="6" stroke="url(#brandGrad)" stroke-width="3" fill="none"/>
          </svg>
          <span class="brand-name">HangO</span>
        </div>

        <!-- Tab Navigation -->
        <div class="form-tabs">
          <button class="tab-button active" data-tab="signup" id="tabSignup">Sign Up</button>
          <button class="tab-button" data-tab="login" id="tabLogin">Log In</button>
        </div>

        <!-- Signup Form -->
        <div class="tab-content active" id="signupCard">
          <div class="form-title">
            <h1>Create your account</h1>
            <p>Join the HangO community and connect with amazing people</p>
          </div>

          <form id="signupForm" class="auth-form">
            <div class="form-field">
              <label for="signupFullName">full name<span class="required">*</span></label>
              <input 
                type="text" 
                id="signupFullName" 
                placeholder="Enter your full name" 
                autocomplete="name" 
                required
              />
            </div>

            <div class="form-field">
              <label for="signupUsername">username<span class="required">*</span></label>
              <input 
                type="text" 
                id="signupUsername" 
                placeholder="Enter your username" 
                autocomplete="username" 
                required
              />
            </div>

            <div class="form-field">
              <label for="signupEmail">email<span class="required">*</span></label>
              <input 
                type="email" 
                id="signupEmail" 
                placeholder="Enter your email address" 
                autocomplete="email" 
                required
              />
            </div>

            <div class="form-field">
              <label for="signupPhone">phone number</label>
              <div class="phone-input-group">
                <div class="country-code-wrapper">
                  <select id="countryCode" class="country-code-select">
                    <option value="+1" data-flag="us">+1 US/CA</option>
                    <option value="+44" data-flag="gb">+44 UK</option>
                    <option value="+33" data-flag="fr">+33 France</option>
                    <option value="+49" data-flag="de">+49 Germany</option>
                    <option value="+39" data-flag="it">+39 Italy</option>
                    <option value="+34" data-flag="es">+34 Spain</option>
                    <option value="+86" data-flag="cn">+86 China</option>
                    <option value="+81" data-flag="jp">+81 Japan</option>
                    <option value="+82" data-flag="kr">+82 S.Korea</option>
                    <option value="+91" data-flag="in">+91 India</option>
                    <option value="+55" data-flag="br">+55 Brazil</option>
                    <option value="+52" data-flag="mx">+52 Mexico</option>
                    <option value="+61" data-flag="au">+61 Australia</option>
                    <option value="+7" data-flag="ru">+7 Russia</option>
                    <option value="+90" data-flag="tr">+90 Turkey</option>
                    <option value="+31" data-flag="nl">+31 Netherlands</option>
                    <option value="+46" data-flag="se">+46 Sweden</option>
                    <option value="+47" data-flag="no">+47 Norway</option>
                    <option value="+45" data-flag="dk">+45 Denmark</option>
                    <option value="+41" data-flag="ch">+41 Switzerland</option>
                    <option value="+43" data-flag="at">+43 Austria</option>
                    <option value="+32" data-flag="be">+32 Belgium</option>
                    <option value="+351" data-flag="pt">+351 Portugal</option>
                    <option value="+65" data-flag="sg">+65 Singapore</option>
                    <option value="+971" data-flag="ae">+971 UAE</option>
                  </select>
                  <div class="flag-display" id="flagDisplay">
                    <img src="https://flagcdn.com/24x18/us.png" alt="US Flag" class="flag-img" />
                  </div>
                </div>
                <input 
                  type="tel" 
                  id="signupPhone" 
                  placeholder="Enter your phone number" 
                  autocomplete="tel" 
                />
              </div>
            </div>

            <div class="form-field">
              <label for="signupPassword">password<span class="required">*</span></label>
              <div class="password-input">
                <input 
                  type="password" 
                  id="signupPassword" 
                  placeholder="Enter your password" 
                  autocomplete="new-password" 
                  required
                />
                <button type="button" class="password-toggle" id="toggleSignupPw">üëÅÔ∏è</button>
              </div>
              <div class="password-strength" id="passwordStrength">
                <div class="strength-bar">
                  <div class="strength-fill" id="strengthFill"></div>
                </div>
                <span class="strength-text" id="strengthText">Password strength</span>
              </div>
            </div>

            <div class="form-field">
              <label for="signupAvatar">Avatar</label>
              <input type="hidden" id="signupAvatar" name="avatar" value="">
              <div class="avatar-gallery">
                <div class="avatar-options">
                  <button type="button" class="avatar-option" data-src="https://api.dicebear.com/7.x/adventurer/svg?seed=Felix&size=150"></button>
                  <button type="button" class="avatar-option" data-src="https://api.dicebear.com/7.x/adventurer/svg?seed=Luna&size=150"></button>
                  <button type="button" class="avatar-option" data-src="https://api.dicebear.com/7.x/adventurer/svg?seed=Max&size=150"></button>
                  <button type="button" class="avatar-option" data-src="https://api.dicebear.com/7.x/adventurer/svg?seed=Zoe&size=150"></button>
                  <button type="button" class="avatar-option" data-src="https://api.dicebear.com/7.x/adventurer/svg?seed=Oliver&size=150"></button>
                  <button type="button" class="avatar-option" data-src="https://api.dicebear.com/7.x/adventurer/svg?seed=Mia&size=150"></button>
                </div>
              </div>
            </div>

            <button type="submit" class="btn-primary">Sign Up</button>

            <div class="divider">
              <span>or</span>
            </div>

            <div class="oauth-buttons">
              <a href="/auth/google" class="btn-oauth">
                <svg width="20" height="20" viewBox="0 0 24 24">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign Up with Google
              </a>
              
              <a href="/auth/github" class="btn-oauth">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#000">
                  <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                Sign Up with GitHub
              </a>
            </div>
          </form>
        </div>

        <!-- Login Form -->
        <div class="tab-content" id="loginCard">
          <div class="form-title">
            <h1>Log in to your account</h1>
            <p>Welcome back! Please sign in to continue</p>
          </div>

          <form id="loginForm" class="auth-form">
            <div class="form-field">
              <label for="loginUsername">username<span class="required">*</span></label>
              <input 
                type="text" 
                id="loginUsername" 
                placeholder="Enter your username" 
                autocomplete="username" 
                required
              />
            </div>

            <div class="form-field">
              <label for="loginPassword">password<span class="required">*</span></label>
              <div class="password-input">
                <input 
                  type="password" 
                  id="loginPassword" 
                  placeholder="Enter your password" 
                  autocomplete="current-password" 
                  required
                />
                <button type="button" class="password-toggle" id="toggleLoginPw">üëÅÔ∏è</button>
              </div>
            </div>

            <button type="submit" class="btn-primary">Log In</button>

            <div class="divider">
              <span>or</span>
            </div>

            <div class="oauth-buttons">
              <a href="/auth/google" class="btn-oauth">
                <svg width="20" height="20" viewBox="0 0 24 24">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign In with Google
              </a>
              
              <a href="/auth/github" class="btn-oauth">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#000">
                  <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                Sign In with GitHub
              </a>
            </div>

            <div class="forgot-password">
              <a href="#" class="link" id="forgotPasswordLink">Forgot your password?</a>
            </div>
          </form>
        </div>

        <div class="modal-overlay" id="forgotPasswordModal" style="display: none;">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Reset Your Password</h2>
              <button type="button" class="modal-close" id="closeForgotModal">&times;</button>
            </div>
            <div class="modal-body">
              <p>Enter your email address and we'll send you a link to reset your password.</p>
              <form id="forgotPasswordForm">
                <div class="form-field">
                  <label for="resetEmail">Email Address</label>
                  <input 
                    type="email" 
                    id="resetEmail" 
                    placeholder="Enter your email address" 
                    required
                  />
                </div>
                <button type="submit" class="btn-primary">Send Reset Link</button>
              </form>
              <div class="forgot-message" id="forgotMsg"></div>
            </div>
          </div>
        </div>

        <div class="auth-message" id="authMsg"></div>
      </div>
    </div>

    <div class="auth-info-panel">
      <div class="info-content">
        <div class="illustration">
          <svg width="300" height="200" viewBox="0 0 300 200" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="150" cy="100" r="80" fill="url(#grad1)" opacity="0.1"/>
            <circle cx="120" cy="80" r="20" fill="url(#grad2)"/>
            <circle cx="180" cy="80" r="20" fill="url(#grad3)"/>
            <path d="M110 120 Q150 150 190 120" stroke="url(#grad4)" stroke-width="4" fill="none"/>
            <defs>
              <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#0066ff"/>
                <stop offset="100%" stop-color="#00ccff"/>
              </linearGradient>
              <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#ff6b6b"/>
                <stop offset="100%" stop-color="#ff8e53"/>
              </linearGradient>
              <linearGradient id="grad3" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#4ecdc4"/>
                <stop offset="100%" stop-color="#44a08d"/>
              </linearGradient>
              <linearGradient id="grad4" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#667eea"/>
                <stop offset="100%" stop-color="#764ba2"/>
              </linearGradient>
            </defs>
          </svg>
        </div>

        <div class="info-card" id="signupInfo">
          <h2>Welcome to HangO Community</h2>
          <p>Join thousands of people who are already connecting, sharing, and building meaningful relationships on HangO.</p>
          
          <div class="features">
            <div class="feature-item">
              <div class="feature-icon">üöÄ</div>
              <div class="feature-text">
                <h3>Fast & Reliable</h3>
                <p>Lightning-fast connections with 99.9% uptime</p>
              </div>
            </div>
            
            <div class="feature-item">
              <div class="feature-icon">üîí</div>
              <div class="feature-text">
                <h3>Secure & Private</h3>
                <p>Your data is encrypted and protected at all times</p>
              </div>
            </div>
            
            <div class="feature-item">
              <div class="feature-icon">üë•</div>
              <div class="feature-text">
                <h3>Growing Community</h3>
                <p>Connect with like-minded people from around the world</p>
              </div>
            </div>
          </div>
        </div>

        <div class="info-card" id="loginInfo" style="display: none;">
          <h2>Welcome Back</h2>
          <p>Great to see you again! Sign in to continue your journey and reconnect with your HangO community.</p>
          
          <div class="features">
            <div class="feature-item">
              <div class="feature-icon">üè†</div>
              <div class="feature-text">
                <h3>Pick Up Where You Left Off</h3>
                <p>Your conversations and connections are waiting for you</p>
              </div>
            </div>
            
            <div class="feature-item">
              <div class="feature-icon">üîî</div>
              <div class="feature-text">
                <h3>Stay Updated</h3>
                <p>See what's new in your community since your last visit</p>
              </div>
            </div>
            
            <div class="feature-item">
              <div class="feature-icon">‚ö°</div>
              <div class="feature-text">
                <h3>Instant Access</h3>
                <p>Quick and secure login to get you connected fast</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function checkOAuthErrors() {
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');
      
      if (error) {
        let errorMessage = 'Authentication failed. Please try again.';
        
        switch(error) {
          case 'github_failed':
            errorMessage = 'GitHub authentication failed. Please try again or contact support if the issue persists.';
            break;
          case 'google_failed':
            errorMessage = 'Google authentication failed. Please try again or contact support if the issue persists.';
            break;
          case 'username_taken':
            errorMessage = 'The username from your social account is already taken. Please try signing up with a different account or contact support.';
            break;
          case 'email_exists':
            errorMessage = 'An account with this email already exists. Please try signing in with your existing method or use a different email.';
            break;
        }
        
        showMessage(errorMessage);
     
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    function setTab(tabName) {
      const tabs = document.querySelectorAll('.tab-button');
      const contents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => {
        tab.classList.remove('active');
      });
      
      contents.forEach(content => {
        content.classList.remove('active');
      });
      
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(tabName + 'Card').classList.add('active');
    
      const signupInfo = document.getElementById('signupInfo');
      const loginInfo = document.getElementById('loginInfo');
      
      if (tabName === 'login') {
        signupInfo.style.display = 'none';
        loginInfo.style.display = 'block';
      } else {
        signupInfo.style.display = 'block';
        loginInfo.style.display = 'none';
      }
    }

    $('tabSignup').addEventListener('click', () => setTab('signup'));
    $('tabLogin').addEventListener('click', () => setTab('login'));

   
    function setupPasswordToggle(inputId, toggleId) {
      const input = $(inputId);
      const toggle = $(toggleId);
      
      toggle.addEventListener('click', () => {
        const isPassword = input.type === 'password';
        input.type = isPassword ? 'text' : 'password';
        toggle.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
      });
    }

    setupPasswordToggle('signupPassword', 'toggleSignupPw');
    setupPasswordToggle('loginPassword', 'toggleLoginPw');

    const strengthFill = $('strengthFill');
    const strengthText = $('strengthText');

    function calculatePasswordStrength(password) {
      let score = 0;
      if (password.length >= 8) score++;
      if (password.length >= 12) score++;
      if (/[a-z]/.test(password)) score++;
      if (/[A-Z]/.test(password)) score++;
      if (/\d/.test(password)) score++;
      if (/[^a-zA-Z0-9]/.test(password)) score++;
      return Math.min(score, 6);
    }

    function updatePasswordStrength() {
      const password = $('signupPassword').value;
      const score = calculatePasswordStrength(password);
      const percentage = (score / 6) * 100;
      
      strengthFill.style.width = percentage + '%';
      
      const labels = [
        'Very Weak',
        'Weak', 
        'Fair',
        'Good',
        'Strong',
        'Very Strong',
        'Excellent'
      ];
      
      strengthText.textContent = password ? labels[score] : 'Password strength';
    }

    $('signupPassword').addEventListener('input', updatePasswordStrength);

    function formatPhoneNumber(value, countryCode) {
      const digits = value.replace(/\D/g, '');
      
      if (countryCode === '+1') {
        // US/Canada formatting
        if (digits.length >= 6) {
          return digits.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
        } else if (digits.length >= 3) {
          return digits.replace(/(\d{3})(\d{0,3})/, '($1) $2');
        }
      } else if (countryCode === '+44') {
        // UK formatting
        if (digits.length >= 7) {
          return digits.replace(/(\d{4})(\d{3})(\d{4})/, '$1 $2 $3');
        } else if (digits.length >= 4) {
          return digits.replace(/(\d{4})(\d{0,3})/, '$1 $2');
        }
      } else {
        // Generic formatting for other countries
        if (digits.length >= 8) {
          return digits.replace(/(\d{3})(\d{3})(\d+)/, '$1 $2 $3');
        } else if (digits.length >= 3) {
          return digits.replace(/(\d{3})(\d{0,5})/, '$1 $2');
        }
      }
      
      return digits;
    }

    $('signupPhone').addEventListener('input', (e) => {
      const countryCode = $('countryCode').value;
      const formattedValue = formatPhoneNumber(e.target.value, countryCode);
      e.target.value = formattedValue;
    });

    // Reformat phone number when country code changes
    $('countryCode').addEventListener('change', (e) => {
      const phoneInput = $('signupPhone');
      const selectedOption = e.target.options[e.target.selectedIndex];
      const flagCode = selectedOption.getAttribute('data-flag');
      const countryCode = selectedOption.value;
      
      // Update flag display
      const flagDisplay = $('flagDisplay');
      const flagImg = flagDisplay.querySelector('.flag-img');
      flagImg.src = `https://flagcdn.com/24x18/${flagCode}.png`;
      flagImg.alt = `${flagCode.toUpperCase()} Flag`;
      
      // Update or create display text
      let displayText = flagDisplay.querySelector('.flag-text');
      if (!displayText) {
        displayText = document.createElement('span');
        displayText.className = 'flag-text';
        flagDisplay.appendChild(displayText);
      }
      displayText.textContent = countryCode;
      
      // Reformat existing phone number
      if (phoneInput.value) {
        const formattedValue = formatPhoneNumber(phoneInput.value, countryCode);
        phoneInput.value = formattedValue;
      }
    });

    // Initialize flag display on page load
    document.addEventListener('DOMContentLoaded', () => {
      const countryCodeSelect = $('countryCode');
      const flagDisplay = $('flagDisplay');
      
      if (countryCodeSelect && flagDisplay) {
        const initialOption = countryCodeSelect.options[countryCodeSelect.selectedIndex];
        const initialFlag = initialOption.getAttribute('data-flag');
        const initialCode = initialOption.value;
        
        // Set initial flag
        const flagImg = flagDisplay.querySelector('.flag-img');
        if (flagImg) {
          flagImg.src = `https://flagcdn.com/24x18/${initialFlag}.png`;
          flagImg.alt = `${initialFlag.toUpperCase()} Flag`;
        }
        
        // Add initial text if it doesn't exist
        let displayText = flagDisplay.querySelector('.flag-text');
        if (!displayText) {
          displayText = document.createElement('span');
          displayText.className = 'flag-text';
          flagDisplay.appendChild(displayText);
        }
        displayText.textContent = initialCode;
      }
    });

    // Avatar selection
    const avatarOptions = document.querySelectorAll('.avatar-option');
    const avatarInput = $('signupAvatar');

    avatarOptions.forEach((option, index) => {
      const src = option.dataset.src;
      option.style.backgroundImage = `url(${src})`;
      
      option.addEventListener('click', () => {
        avatarOptions.forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        avatarInput.value = src;
      });
    });

    // Form submission
    function showMessage(text, isSuccess = false) {
      const authMsg = $('authMsg');
      authMsg.textContent = text;
      authMsg.className = 'auth-message ' + (isSuccess ? 'success' : 'error');
    }

    $('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('Signup form submitted');
      
      const fullName = $('signupFullName').value.trim();
      const username = $('signupUsername').value.trim();
      const email = $('signupEmail').value.trim();
      const countryCode = $('countryCode').value;
      const phoneNumber = $('signupPhone').value.trim();
      const phone = phoneNumber ? `${countryCode} ${phoneNumber}` : '';
      const password = $('signupPassword').value;
      
      // Get selected avatar
      const selectedAvatar = document.querySelector('.avatar-option.selected');
      const avatar = selectedAvatar ? selectedAvatar.getAttribute('data-src') : '';
      
      console.log('Form data:', { fullName, username, email, phone, password, avatar });
      
      // Client-side validation
      if (!fullName) {
        showMessage('Full name is required.');
        return;
      }
      
      if (fullName.length < 2) {
        showMessage('Full name must be at least 2 characters long.');
        return;
      }
      
      if (!username) {
        showMessage('Username is required.');
        return;
      }
      
      if (username.length < 3) {
        showMessage('Username must be at least 3 characters long.');
        return;
      }
      
      if (!email) {
        showMessage('Email is required.');
        return;
      }
      
      if (!/\S+@\S+\.\S+/.test(email)) {
        showMessage('Please enter a valid email address.');
        return;
      }
      
      // Phone number is now optional
      if (phoneNumber && phoneNumber.length < 5) {
        showMessage('Please enter a valid phone number or leave it empty.');
        return;
      }
      
      if (!password) {
        showMessage('Password is required.');
        return;
      }
      
      if (password.length < 6) {
        showMessage('Password must be at least 6 characters long.');
        return;
      }
      
      try {
        showMessage('Creating your account...', true);
        
        console.log('Sending registration request...');
        const response = await fetch('/api/user/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fullName, username, email, phone, password, avatar })
        });
        
        console.log('Server response status:', response.status);
        console.log('Server response:', response);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Signup response data:', data);
        
        if (data.success) {
          showMessage(data.message || 'Account created successfully! Please check your email to verify your account.', true);
          
          // Clear the form
          $('signupForm').reset();
          document.querySelectorAll('.avatar-option').forEach(option => option.classList.remove('selected'));
          
          setTimeout(() => setTab('login'), 3000);
        } else {
          showMessage(data.error || 'Signup failed. Please try again.');
        }
      } catch (error) {
        console.error('Signup error:', error);
        showMessage('Network error. Please check your internet connection and try again.');
      }
    });

    $('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = $('loginUsername').value.trim();
      const password = $('loginPassword').value;
      
      // Client-side validation
      if (!username) {
        showMessage('Username is required.');
        return;
      }
      
      if (!password) {
        showMessage('Password is required.');
        return;
      }
      
      try {
        showMessage('Signing you in...', true);
        
        const response = await fetch('/api/user/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showMessage(`Welcome back, ${data.user.username}!`, true);
          setTimeout(() => {
            window.location.href = '/';
          }, 1500);
        } else {
          showMessage(data.error || 'Login failed. Please check your credentials.');
        }
      } catch (error) {
        showMessage('Network error. Please check your internet connection and try again.');
        console.error('Login error:', error);
      }
    });

    // Forgot Password Modal Functionality
    const forgotPasswordModal = $('forgotPasswordModal');
    const forgotPasswordLink = $('forgotPasswordLink');
    const closeForgotModal = $('closeForgotModal');
    const forgotPasswordForm = $('forgotPasswordForm');

    // Show forgot password modal
    forgotPasswordLink.addEventListener('click', (e) => {
      e.preventDefault();
      forgotPasswordModal.style.display = 'flex';
      $('resetEmail').focus();
    });

    // Close modal functions
    const closeForgotPasswordModal = () => {
      forgotPasswordModal.style.display = 'none';
      forgotPasswordForm.reset();
      showForgotMessage(''); // Clear any messages
    };

    closeForgotModal.addEventListener('click', closeForgotPasswordModal);

    // Close modal when clicking overlay
    forgotPasswordModal.addEventListener('click', (e) => {
      if (e.target === forgotPasswordModal) {
        closeForgotPasswordModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && forgotPasswordModal.style.display === 'flex') {
        closeForgotPasswordModal();
      }
    });

    // Show message in forgot password modal
    function showForgotMessage(text, isSuccess = false) {
      const forgotMsg = $('forgotMsg');
      forgotMsg.textContent = text;
      forgotMsg.className = 'forgot-message ' + (isSuccess ? 'success' : 'error');
    }

    // Handle forgot password form submission
    forgotPasswordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = $('resetEmail').value.trim();
      
      if (!email) {
        showForgotMessage('Please enter your email address.');
        return;
      }
      
      if (!/\S+@\S+\.\S+/.test(email)) {
        showForgotMessage('Please enter a valid email address.');
        return;
      }
      
      try {
        showForgotMessage('Sending reset link...', true);
        
        const response = await fetch('/api/user/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showForgotMessage('Reset link sent! Check your email for instructions.', true);
          setTimeout(() => {
            closeForgotPasswordModal();
          }, 3000);
        } else {
          // Handle specific error types
          if (response.status === 404) {
            showForgotMessage('‚ùå No account found with this email address. Please check your email or create a new account.');
          } else if (response.status === 503) {
            showForgotMessage('‚ö†Ô∏è Password reset feature requires database setup. Please contact support.');
          } else {
            showForgotMessage(data.error || 'Failed to send reset link. Please try again.');
          }
        }
      } catch (error) {
        console.error('Forgot password error:', error);
        showForgotMessage('Network error. Please check your internet connection and try again.');
      }
    });

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Check for success messages from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const message = urlParams.get('message');
      
      if (message) {
        showSuccess(message);
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      checkOAuthErrors();
    });
  </script>
</body>
</html>
